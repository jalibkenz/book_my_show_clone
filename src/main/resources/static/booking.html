<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Seat</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    .container{max-width:720px;margin:0 auto}
    .row{display:flex;gap:12px;margin-bottom:12px}
    .seat{padding:8px 12px;border:1px solid #ddd;border-radius:6px;cursor:pointer}
    .seat.held{background:#fef3c7}
    .seat.booked{background:#fca5a5;color:#fff}
    button{padding:12px 18px;border-radius:8px;background:#2563eb;color:#fff;border:none}
  </style>
</head>
<body>
<div class="container">
  <h1>Select seat and pay</h1>
  <div>
    <label>Show ID</label>
    <input id="showId" placeholder="Enter show id or add ?showId=... in URL" style="width:100%"/>
    <button onclick="loadSeats()">Load seats</button>
  </div>

  <h3>Seats</h3>
  <div id="seats" style="display:flex;flex-wrap:wrap;gap:8px"></div>

  <div style="margin-top:18px">
    <label>Your name</label>
    <input id="name" style="width:100%;padding:8px;margin-bottom:8px"/>
    <label>Your email</label>
    <input id="email" style="width:100%;padding:8px;margin-bottom:8px"/>
    <label>Seat</label>
    <input id="seatNumber" readonly style="width:100%;padding:8px;margin-bottom:8px"/>
    <button id="payBtn" onclick="startBooking()" disabled>Hold & Pay</button>
  </div>

  <div id="status" style="margin-top:18px;color:#d1d5db"></div>
</div>

<script>
let razorpayKey;
let currentBookingId=null;
window.onload = ()=>{
  const params = new URLSearchParams(window.location.search);
  const s = params.get('showId');
  if(s) document.getElementById('showId').value = s;
  fetch('/payments/config').then(r=>r.json()).then(c=>{ razorpayKey=c.razorpayKeyId; });
}

function loadSeats(){
  const showId = document.getElementById('showId').value.trim();
  if(!showId) return alert('Enter show id');
  fetch('/shows/' + showId + '/seats')
    .then(r=>r.json())
    .then(data=>{
      const container = document.getElementById('seats');
      container.innerHTML='';
      data.forEach(s=>{
        const el = document.createElement('div');
        el.className = 'seat ' + (s.bookingShowSeatStatus.toLowerCase());
        el.textContent = s.seatNumber + ' (' + s.bookingShowSeatStatus + ')';
        el.onclick = ()=>{
          if(s.bookingShowSeatStatus !== 'AVAILABLE') return alert('Seat not available');
          document.getElementById('seatNumber').value = s.seatNumber;
          document.getElementById('payBtn').disabled = false;
        };
        container.appendChild(el);
      });
    })
    .catch(e=>alert('failed to load seats'))
}

function startBooking(){
  const showId = document.getElementById('showId').value.trim();
  const seat = document.getElementById('seatNumber').value.trim();
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  if(!seat || !name || !email) return alert('Enter required fields');

  // 1. create hold
  fetch('/shows/' + showId + '/bookings', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ userId: '00000000-0000-0000-0000-000000000000', seatNumber: seat })
  }).then(r=>r.text()).then(bookingId=>{
    currentBookingId = bookingId.replace(/"/g,'');
    document.getElementById('status').textContent = 'Held booking: ' + currentBookingId;

    // 2. initiate payment for booking
    return fetch('/bookings/' + currentBookingId + '/pay/initiate', { method:'POST' });
  }).then(r=>r.json()).then(res=>{
    // open razorpay
    const options = {
      key: razorpayKey,
      order_id: res.razorpayOrderId,
      amount: res.amount * 100,
      currency: res.currency,
      name: 'BookMyShow',
      handler: verify,
      prefill:{name:name,email:email}
    };
    new Razorpay(options).open();
  }).catch(e=>{ alert('Failed: ' + e); });
}

function verify(resp){
  // call payment verify
  fetch('/payments/verify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ razorpayOrderId: resp.razorpay_order_id, razorpayPaymentId: resp.razorpay_payment_id, razorpaySignature: resp.razorpay_signature }) })
  .then(()=>{
    alert('Payment verified - ticket will be emailed');
  }).catch(()=>alert('Payment verification failed'))
}
</script>
</body>
</html>

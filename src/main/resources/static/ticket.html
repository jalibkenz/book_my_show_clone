<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Ticket Booking</title>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    :root {
      --blue-bg:#e0f2fe;
      --blue-btn:#0284c7;
      --blue-title:#0369a1;
      --border:#d1d5db;
    }

    * { box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Arial;
      background:var(--blue-bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .container{
      width:100%;
      max-width:520px;
      background:#fff;
      padding:36px 32px;
      border-radius:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.12);
    }

    h2{
      text-align:center;
      font-size:32px;
      margin-bottom:28px;
      color:var(--blue-title);
    }

    label{
      display:block;
      font-size:16px;
      margin-bottom:8px;
      color:#374151;
    }

    input{
      width:100%;
      height:52px;
      padding:0 14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:16px;
      margin-bottom:22px;
    }

    input:focus{
      outline:none;
      border-color:var(--blue-btn);
      box-shadow:0 0 0 2px rgba(2,132,199,.15);
    }

    button{
      width:100%;
      height:54px;
      font-size:18px;
      font-weight:600;
      background:var(--blue-btn);
      color:#fff;
      border:none;
      border-radius:12px;
      cursor:pointer;
    }

    button:disabled{
      background:#9ca3af;
      cursor:not-allowed;
    }

    .footer{
      margin-top:22px;
      text-align:center;
      font-size:14px;
      color:#6b7280;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(255, 255, 255, 0.9);
      z-index: 1000;
    }

    .box{
      background:#fff;
      padding:44px 36px;
      border-radius:18px;
      text-align:center;
      max-width:480px;
      width:100%;
      box-shadow:0 20px 45px rgba(0,0,0,.18);
    }

    .box h1{
      font-size:34px;
      color:#15803d;
      margin-top:0;
    }
    
    .ticket-info {
        text-align: left;
        margin: 20px 0;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px dashed var(--blue-btn);
    }
    
    .ticket-info p {
        margin: 5px 0;
    }
  </style>
</head>

<body>

<!-- BOOKING FORM -->
<div id="bookingForm" class="container">
  <h2>Book Ticket</h2>

  <label>User ID *</label>
  <input id="userId" type="text" placeholder="UUID of the user" required>

  <label>Show ID *</label>
  <input id="showId" type="text" placeholder="UUID of the show" required>

  <label>Seat Number *</label>
  <input id="seatNumber" type="text" placeholder="e.g. A1" required>

  <button id="bookBtn" onclick="initiateBooking()" disabled>Hold & Pay</button>
  <div class="footer">Powered by Razorpay</div>
</div>

<!-- PROCESSING -->
<div id="processing" class="overlay">
  <div class="box">
    <h1 id="processingText">Processing...</h1>
    <p>Please wait, do not refresh.</p>
  </div>
</div>

<!-- SUCCESS -->
<div id="success" class="overlay">
  <div class="box">
    <h1>Booking Confirmed! üéüÔ∏è</h1>
    <div class="ticket-info">
        <p><strong>Booking ID:</strong> <span id="resBookingId"></span></p>
        <p><strong>Status:</strong> BOOKED</p>
        <p>A confirmation email with your ticket PDF has been sent.</p>
    </div>
    <button onclick="location.reload()">Book Another</button>
  </div>
</div>

<script>
  let razorpayKey=null;
  let currentBookingId=null;
  let processing=false;

  window.onload=()=>{
    const backendUrl = window.location.port === "63342" ? "http://localhost:8080" : "";
    fetch(`${backendUrl}/payments/config`)
      .then(r=>r.json())
      .then(c=>{
        razorpayKey=c.razorpayKeyId;
        document.getElementById("bookBtn").disabled=false;
      })
      .catch(err => console.error("Failed to load config", err));
  };

  async function initiateBooking(){
    if(processing) return;

    const backendUrl = window.location.port === "63342" ? "http://localhost:8080" : "";
    const userId = document.getElementById("userId").value.trim();
    const showId = document.getElementById("showId").value.trim();
    const seatNumber = document.getElementById("seatNumber").value.trim();

    if(!userId || !showId || !seatNumber) return alert("All fields are required");

    setProcessing(true, "Holding your seat...");

    try {
        // 1. Hold Seat
        const holdRes = await fetch(`${backendUrl}/bookings/shows/${showId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, seatNumber })
        });
        
        if (!holdRes.ok) {
            const err = await holdRes.text();
            throw new Error(err || "Failed to hold seat");
        }
        
        currentBookingId = await holdRes.json();
        
        // 2. Initiate Payment
        setProcessing(true, "Initiating payment...");
        const payInitRes = await fetch(`${backendUrl}/bookings/${currentBookingId}/pay/initiate`, {
            method: "POST"
        });
        
        if (!payInitRes.ok) throw new Error("Failed to initiate payment");
        
        const payData = await payInitRes.json();
        openCheckout(payData);
        
    } catch (err) {
        alert(err.message);
        setProcessing(false);
    }
  }

  function openCheckout(data){
    const backendUrl = window.location.port === "63342" ? "http://localhost:8080" : "";
    const options={
      key:razorpayKey,
      order_id:data.razorpayOrderId,
      amount:data.amount,
      currency:data.currency,
      name:"BookMyShow",
      description: "Movie Ticket Booking",
      handler: (res) => verifyAndConfirm(res, backendUrl),
      modal:{
        ondismiss:()=>{
          setProcessing(false);
        }
      }
    };
    new Razorpay(options).open();
  }

  async function verifyAndConfirm(res, backendUrl){
    setProcessing(true, "Verifying payment...");

    try {
        // 3. Verify Payment
        const verifyRes = await fetch(`${backendUrl}/payments/verify`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                razorpayPaymentId: res.razorpay_payment_id,
                razorpayOrderId: res.razorpay_order_id,
                razorpaySignature: res.razorpay_signature
            })
        });

        if (!verifyRes.ok) {
            const data = await verifyRes.json();
            throw new Error(data.message || "Payment verification failed");
        }

        // 4. Finalize Booking
        setProcessing(true, "Finalizing booking...");
        const finalizeRes = await fetch(`${backendUrl}/payments/bookings/${currentBookingId}/pay`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                paymentId: res.razorpay_payment_id
            })
        });

        if (!finalizeRes.ok) {
            const data = await finalizeRes.json().catch(() => ({}));
            throw new Error(data.message || "Failed to finalize booking");
        }

        showSuccess();
    } catch (err) {
        alert(err.message);
        setProcessing(false);
    }
  }

  function setProcessing(isProcessing, text = "Processing...") {
    processing = isProcessing;
    document.getElementById("processing").style.display = isProcessing ? "flex" : "none";
    document.getElementById("processingText").innerText = text;
    document.getElementById("bookBtn").disabled = isProcessing;
  }

  function showSuccess() {
    setProcessing(false);
    document.getElementById("bookingForm").style.display = "none";
    document.getElementById("success").style.display = "flex";
    document.getElementById("resBookingId").innerText = currentBookingId;
  }
</script>

</body>
</html>
